require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const { handleStart, handleHelp, handleShop, handleCallbackQuery } = require('./handlers');
const { handlePreCheckoutQuery, handleSuccessfulPayment } = require('./payments');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
if (!process.env.BOT_TOKEN) {
  console.error('‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ');
  process.exit(1);
}

// –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞
const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });

console.log('ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!');

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => handleStart(bot, msg));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help
bot.onText(/\/help/, (msg) => handleHelp(bot, msg));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /shop
bot.onText(/\/shop/, (msg) => handleShop(bot, msg));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫
bot.on('callback_query', (query) => handleCallbackQuery(bot, query));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ pre-checkout –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π)
bot.on('pre_checkout_query', (query) => handlePreCheckoutQuery(bot, query));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
bot.on('successful_payment', (msg) => handleSuccessfulPayment(bot, msg));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('polling_error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error.message);
});

module.exports = bot;
